<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Movies Data</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        
        .container {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
        }
        
        .log {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log div {
            margin: 2px 0;
        }
        
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        button:hover:not(:disabled) {
            background: #45a049;
        }
        
        .download-link {
            display: none;
            background: #2196F3;
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 4px;
            margin: 10px 5px;
            display: inline-block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: #3d3d3d;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ VitaFlix Movies Data Builder</h1>
        <p>Tool n√†y s·∫Ω fetch t·∫•t c·∫£ phim t·ª´ API v√† t·∫°o file movies-data.json</p>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalMovies">0</div>
                <div>T·ªïng phim</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="currentCountry">-</div>
                <div>Qu·ªëc gia hi·ªán t·∫°i</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="currentPage">0</div>
                <div>Trang hi·ªán t·∫°i</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="progress">0%</div>
                <div>Ti·∫øn ƒë·ªô</div>
            </div>
        </div>
        
        <button id="startBtn" onclick="startBuild()">üöÄ B·∫Øt ƒë·∫ßu Build</button>
        <button id="stopBtn" onclick="stopBuild()" disabled>‚èπÔ∏è D·ª´ng l·∫°i</button>
        <a id="downloadBtn" class="download-link" style="display: none;" download="movies-data.json">üì• T·∫£i v·ªÅ movies-data.json</a>
        
        <div class="log" id="logContainer"></div>
    </div>

    <script>
        class Movie {
            constructor(movieDetail, movieParams = {}) {
                this._id = movieDetail._id;
                this.name = movieDetail.name;
                this.origin_name = movieDetail.origin_name;
                this.poster_url = movieDetail.poster_url;
                this.slug = movieDetail.slug;
                this.thumb_url = movieDetail.thumb_url;
                this.year = movieDetail.year;
                this.type = movieDetail.type || 'unknown';
                this.episode_current = movieDetail.episode_current;
                this.quality = movieDetail.quality || 'unknown';
                this.modified = movieDetail.modified;
                this.country_slug = movieParams?.slug || '';
                this.country_name_slug = movieParams?.type_slug || '';
                this.total_pages = movieParams?.pagination?.totalPages || 0;
                this.current_page = movieParams?.pagination?.currentPage || 0;
            }
        }

        let isBuilding = false;
        let shouldStop = false;
        let allMovies = [];
        
        const countries = [
            { slug: 'han-quoc', name: 'H√†n Qu·ªëc' },
            { slug: 'trung-quoc', name: 'Trung Qu·ªëc' },
            { slug: 'nhat-ban', name: 'Nh·∫≠t B·∫£n' },
            { slug: 'au-my', name: '√Çu M·ªπ' }
        ];

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        function updateStats(totalMovies, currentCountry, currentPage, progress) {
            document.getElementById('totalMovies').textContent = totalMovies;
            document.getElementById('currentCountry').textContent = currentCountry;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('progress').textContent = progress + '%';
        }

        async function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function fetchMoviesFromCountry(countrySlug, countryName) {
            log(`üì• B·∫Øt ƒë·∫ßu fetch ${countryName}...`, 'info');
            
            let page = 1;
            let hasMore = true;
            let countryMovies = [];
            
            while (hasMore && page <= 100 && !shouldStop) { // Gi·ªõi h·∫°n 30 trang
                try {
                    updateStats(allMovies.length, countryName, page, Math.round((countries.findIndex(c => c.slug === countrySlug) * 30 + page) / (countries.length * 30) * 100));
                    
                    log(`ƒêang fetch ${countryName} - trang ${page}`, 'info');
                    
                    const response = await fetch(`https://phimapi.com/v1/api/quoc-gia/${countrySlug}?page=${page}`);
                    
                    if (!response.ok) {
                        log(`‚ö†Ô∏è ${countryName} trang ${page} l·ªói: ${response.status}`, 'warning');
                        break;
                    }
                    
                    const movieData = await response.json();
                    const items = movieData.data?.items || [];
                    const params = movieData.data?.params || {};
                    
                    if (items.length === 0) {
                        log(`‚èπÔ∏è ${countryName} trang ${page} kh√¥ng c√≥ phim, d·ª´ng l·∫°i`, 'info');
                        break;
                    }
                    
                    for (const item of items) {
                        const movie = new Movie(item, params);
                        countryMovies.push(movie);
                        allMovies.push(movie);
                    }
                    
                    log(`‚úÖ ${countryName} trang ${page}: ${items.length} phim (T·ªïng: ${allMovies.length})`, 'success');
                    page++;
                    
                    // Delay ƒë·ªÉ tr√°nh rate limit
                    await delay(300);
                    
                } catch (error) {
                    log(`‚ùå L·ªói khi fetch ${countryName} trang ${page}: ${error.message}`, 'error');
                    break;
                }
            }
            
            log(`üìä Ho√†n th√†nh ${countryName}: ${countryMovies.length} phim`, 'success');
            return countryMovies;
        }

        async function startBuild() {
            if (isBuilding) return;
            
            isBuilding = true;
            shouldStop = false;
            allMovies = [];
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('downloadBtn').style.display = 'none';
            
            log('üöÄ B·∫Øt ƒë·∫ßu build movies data...', 'info');
            
            try {
                for (const country of countries) {
                    if (shouldStop) {
                        log('‚èπÔ∏è Build b·ªã d·ª´ng b·ªüi ng∆∞·ªùi d√πng', 'warning');
                        break;
                    }
                    
                    await fetchMoviesFromCountry(country.slug, country.name);
                }
                
                if (!shouldStop) {
                    // T·∫°o file JSON
                    const movieData = {
                        movies: allMovies,
                        lastUpdate: new Date().toISOString(),
                        totalMovies: allMovies.length,
                        countries: countries.map(c => c.name)
                    };
                    
                    const jsonString = JSON.stringify(movieData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const downloadBtn = document.getElementById('downloadBtn');
                    downloadBtn.href = url;
                    downloadBtn.style.display = 'inline-block';
                    
                    log(`‚úÖ Build ho√†n th√†nh! T·ªïng c·ªông: ${allMovies.length} phim`, 'success');
                    log('üì• Click n√∫t "T·∫£i v·ªÅ" ƒë·ªÉ download file movies-data.json', 'info');
                    
                    updateStats(allMovies.length, 'Ho√†n th√†nh', '-', 100);
                }
                
            } catch (error) {
                log(`‚ùå Build th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                isBuilding = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        function stopBuild() {
            shouldStop = true;
            log('‚èπÔ∏è ƒêang d·ª´ng build...', 'warning');
        }

        // Auto scroll log
        setInterval(() => {
            const logContainer = document.getElementById('logContainer');
            if (logContainer.scrollHeight > logContainer.clientHeight) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }, 1000);
    </script>
</body>
</html>